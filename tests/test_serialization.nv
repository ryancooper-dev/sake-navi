/// Tests for transparent serialization (User Story 3)
///
/// Verifies that handler code works identically in both spawn and
/// WorkerPool modes without manual serialization.

use std.time;
use worker_context.{WorkerContext, WorkerResponse};
use context.Context;
use request.Request;
use response.Response;

// ============================================
// T036: WorkerContext serialization roundtrip
// ============================================

test "worker context serialization roundtrip" {
    let headers: <string, string> = {
        "host": "localhost",
        "content-type": "application/json",
    };

    let query: <string, string> = {
        "page": "2",
        "limit": "50",
    };

    let params: <string, string> = {
        "userId": "123",
        "postId": "456",
    };

    let original = WorkerContext.new(
        "/api/users/123/posts/456",
        "POST",
        headers,
        query,
        params,
        "{\"title\":\"Hello World\"}"
    );

    // Serialize
    let json_str = try! original.to_json();
    assert json_str.len() > 0;

    // Deserialize
    let restored = try! WorkerContext.from_json(json_str);

    // Verify all fields match
    assert_eq restored.path, original.path;
    assert_eq restored.method, original.method;
    assert_eq restored.body, original.body;
    assert_eq restored.headers.get("host"), "localhost";
    assert_eq restored.query.get("page"), "2";
    assert_eq restored.params.get("userId"), "123";
}

test "worker context preserves empty fields" {
    let ctx = WorkerContext.new(
        "/",
        "GET",
        {:},
        {:},
        {:},
        ""
    );

    let json_str = try! ctx.to_json();
    let restored = try! WorkerContext.from_json(json_str);

    assert_eq restored.path, "/";
    assert_eq restored.body, "";
    assert_eq restored.headers.len(), 0;
    assert_eq restored.query.len(), 0;
}

test "worker context handles special characters" {
    let body = "{\"message\":\"Hello \\\"World\\\"!\"}";
    let ctx = WorkerContext.new(
        "/test",
        "POST",
        {:},
        {:},
        {:},
        body
    );

    let json_str = try! ctx.to_json();
    let restored = try! WorkerContext.from_json(json_str);

    assert_eq restored.body, body;
}

// ============================================
// T037: Handler code works identically in both modes
// ============================================

test "context to worker context conversion" {
    let req = try! Request.parse("GET /users/42?active=true HTTP/1.1\r\nHost: api.example.com\r\nAuthorization: Bearer token123\r\n\r\n");
    let params: <string, string> = {"id": "42"};
    let ctx = Context.with_handlers(req, [], params);

    let worker_ctx = ctx.to_worker_context();

    assert_eq worker_ctx.path, "/users/42";
    assert_eq worker_ctx.method, "GET";
    assert_eq worker_ctx.params.get("id"), "42";
    assert_eq worker_ctx.query.get("active"), "true";
    assert_eq worker_ctx.headers.get("host"), "api.example.com";
    assert_eq worker_ctx.headers.get("authorization"), "bearer token123";
}

// ============================================
// T038: Complex request context in WorkerPool
// ============================================

test "complex headers are preserved" {
    let headers: <string, string> = {
        "content-type": "application/json; charset=utf-8",
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, deflate, br",
        "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
        "x-custom-header": "custom-value-123",
    };

    let ctx = WorkerContext.new(
        "/api/data",
        "GET",
        headers,
        {:},
        {:},
        ""
    );

    let json_str = try! ctx.to_json();
    let restored = try! WorkerContext.from_json(json_str);

    assert_eq restored.headers.len(), 5;
    assert_eq restored.headers.get("content-type"), "application/json; charset=utf-8";
    assert_eq restored.headers.get("user-agent"), "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)";
}

test "multiple query parameters are preserved" {
    let query: <string, string> = {
        "search": "hello world",
        "page": "1",
        "limit": "20",
        "sort": "created_at",
        "order": "desc",
        "filter": "active",
    };

    let ctx = WorkerContext.new(
        "/api/search",
        "GET",
        {:},
        query,
        {:},
        ""
    );

    let json_str = try! ctx.to_json();
    let restored = try! WorkerContext.from_json(json_str);

    assert_eq restored.query.len(), 6;
    assert_eq restored.query.get("search"), "hello world";
    assert_eq restored.query.get("sort"), "created_at";
}

test "nested path parameters are preserved" {
    let params: <string, string> = {
        "orgId": "org-123",
        "projectId": "proj-456",
        "taskId": "task-789",
    };

    let ctx = WorkerContext.new(
        "/orgs/org-123/projects/proj-456/tasks/task-789",
        "GET",
        {:},
        {:},
        params,
        ""
    );

    let json_str = try! ctx.to_json();
    let restored = try! WorkerContext.from_json(json_str);

    assert_eq restored.params.len(), 3;
    assert_eq restored.params.get("orgId"), "org-123";
    assert_eq restored.params.get("projectId"), "proj-456";
    assert_eq restored.params.get("taskId"), "task-789";
}

test "large request body is preserved" {
    let body = "{\"data\":[{\"id\":1,\"name\":\"item1\"},{\"id\":2,\"name\":\"item2\"},{\"id\":3,\"name\":\"item3\"}]}";
    let ctx = WorkerContext.new(
        "/api/bulk",
        "POST",
        {"content-type": "application/json"},
        {:},
        {:},
        body
    );

    let json_str = try! ctx.to_json();
    let restored = try! WorkerContext.from_json(json_str);

    assert_eq restored.body.len(), body.len();
    assert restored.body.contains("\"id\":2");
}

// ============================================
// T039: JSON response serialization from WorkerPool
// ============================================

test "worker response serialization roundtrip" {
    let headers: <string, string> = {
        "content-type": "application/json",
        "cache-control": "no-cache",
        "x-request-id": "req-123",
    };

    let body = "{\"status\":\"success\",\"data\":{\"count\":42}}";

    let original = WorkerResponse.new(200, headers, body);

    let json_str = try! original.to_json();
    let restored = try! WorkerResponse.from_json(json_str);

    assert_eq restored.status, 200;
    assert_eq restored.body, body;
    assert_eq restored.headers.get("content-type"), "application/json";
    assert_eq restored.headers.get("x-request-id"), "req-123";
}

test "worker response handles different status codes" {
    let test_cases = [
        (200, "OK"),
        (201, "Created"),
        (204, ""),
        (400, "{\"error\":\"bad request\"}"),
        (401, "{\"error\":\"unauthorized\"}"),
        (404, "{\"error\":\"not found\"}"),
        (500, "{\"error\":\"internal error\"}"),
    ];

    for (let status, body in test_cases) {
        let resp = WorkerResponse.new(status, {:}, body);
        let json_str = try! resp.to_json();
        let restored = try! WorkerResponse.from_json(json_str);

        assert_eq restored.status, status;
        assert_eq restored.body, body;
    }
}

test "worker response preserves empty headers" {
    let resp = WorkerResponse.new(204, {:}, "");

    let json_str = try! resp.to_json();
    let restored = try! WorkerResponse.from_json(json_str);

    assert_eq restored.status, 204;
    assert_eq restored.headers.len(), 0;
    assert_eq restored.body, "";
}

// ============================================
// Error handling tests
// ============================================

test "invalid json throws error" {
    let invalid_json = "{invalid json";
    let result = try? WorkerContext.from_json(invalid_json);
    assert result == nil;
}

test "missing fields in json throws error" {
    let incomplete_json = "{\"path\":\"/test\",\"method\":\"GET\"}";
    let result = try? WorkerContext.from_json(incomplete_json);
    // May fail or succeed with defaults depending on implementation
}

/// Tests for configurable concurrency (User Story 4)
///
/// Verifies that system administrators can configure WorkerPool size,
/// connection limits, and other concurrency settings.

use std.time;
use std.vm;
use config.Config;
use engine.Engine;

// ============================================
// T048: Custom worker_pool_size configuration
// ============================================

test "custom worker pool size" {
    let config = Config.with_defaults().with_worker_pool_size(8);

    assert_eq config.worker_pool_size, 8;
    assert_eq config.effective_worker_pool_size(), 8;
}

test "worker pool size is respected by engine" {
    let config = Config.with_defaults().with_worker_pool_size(2);
    let app = Engine.new(config);

    assert_eq app.config.worker_pool_size, 2;
    assert_eq app.config.effective_worker_pool_size(), 2;
}

// ============================================
// T049: Auto-detection when worker_pool_size=0
// ============================================

test "auto detect worker pool size" {
    let config = Config.with_defaults();

    assert_eq config.worker_pool_size, 0;

    let effective_size = config.effective_worker_pool_size();
    let cpu_count = vm.num_cpus();

    assert_eq effective_size, cpu_count;
    assert effective_size > 0;
}

test "zero worker pool size means auto" {
    let config = Config.with_defaults().with_worker_pool_size(0);

    assert_eq config.worker_pool_size, 0;
    assert config.effective_worker_pool_size() > 0;
}

// ============================================
// T050: enable_worker_pool=false fallback to spawn
// ============================================

test "disable worker pool" {
    let config = Config.with_defaults().with_worker_pool(false);

    assert_eq config.enable_worker_pool, false;
}

test "disabled worker pool does not initialize" {
    let config = Config.with_defaults().with_worker_pool(false);
    let app = Engine.new(config);

    assert_eq app.config.enable_worker_pool, false;
    // Worker pool should not be initialized
    assert app.worker_pool == nil;
}

// ============================================
// T051: max_connections limit enforcement
// ============================================

test "default max connections" {
    let config = Config.with_defaults();
    assert_eq config.max_connections, 10000;
}

test "custom max connections" {
    let config = Config.with_defaults().with_max_connections(500);
    assert_eq config.max_connections, 500;
}

test "validate max connections positive" {
    let config = Config.with_defaults().with_max_connections(0);
    let result = try? config.validate();
    assert result == nil; // Should fail validation
}

// ============================================
// Request timeout tests
// ============================================

test "default request timeout" {
    let config = Config.with_defaults();
    assert_eq config.request_timeout, 30000;
}

test "custom request timeout" {
    let config = Config.with_defaults().with_request_timeout(60000);
    assert_eq config.request_timeout, 60000;
}

test "zero timeout means no timeout" {
    let config = Config.with_defaults().with_request_timeout(0);
    assert_eq config.request_timeout, 0;

    let result = try? config.validate();
    assert result == nil; // Should pass (0 is valid)
}

test "validate negative timeout" {
    let config = Config.with_defaults().with_request_timeout(-1);
    let result = try? config.validate();
    assert result == nil; // Should fail validation
}

// ============================================
// Configuration combinations
// ============================================

test "builder pattern chains correctly" {
    let config = Config.with_defaults()
        .with_worker_pool_size(4)
        .with_worker_pool(true)
        .with_max_connections(1000)
        .with_request_timeout(15000);

    assert_eq config.worker_pool_size, 4;
    assert_eq config.enable_worker_pool, true;
    assert_eq config.max_connections, 1000;
    assert_eq config.request_timeout, 15000;

    let result = try? config.validate();
    assert result == nil; // Should pass all validation
}

test "high performance configuration" {
    let config = Config.with_defaults()
        .with_worker_pool_size(16)
        .with_max_connections(50000)
        .with_request_timeout(10000);

    assert_eq config.worker_pool_size, 16;
    assert_eq config.max_connections, 50000;

    let result = try? config.validate();
    assert result == nil;
}

test "minimal configuration" {
    let config = Config.with_defaults()
        .with_worker_pool(false)
        .with_max_connections(100)
        .with_request_timeout(5000);

    assert_eq config.enable_worker_pool, false;
    assert_eq config.max_connections, 100;

    let result = try? config.validate();
    assert result == nil;
}

// ============================================
// Validation tests
// ============================================

test "valid configuration passes validation" {
    let config = Config.with_defaults();
    let result = try? config.validate();
    assert result == nil; // No error means validation passed
}

test "all valid configurations pass" {
    let configs = [
        Config.with_defaults(),
        Config.with_defaults().with_worker_pool_size(1),
        Config.with_defaults().with_worker_pool_size(16),
        Config.with_defaults().with_worker_pool(false),
        Config.with_defaults().with_max_connections(1),
        Config.with_defaults().with_max_connections(100000),
        Config.with_defaults().with_request_timeout(0),
        Config.with_defaults().with_request_timeout(300000),
    ];

    for (let config in configs) {
        let result = try? config.validate();
        assert result == nil;
    }
}
